<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Tagging AMIs with Installed Software Metadata - Platform Engineering Documentation Site</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Platform Engineering Documentation Site</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Discoveries</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../discoveries/fargate_service_discovery/" class="dropdown-item">Integrating Fargate Services Into Our Existing Systems Architecture</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">How to</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../OpenEdX_Prove_Build_Was_Deployed/" class="dropdown-item">Proving That A Particular OpenEdX Build Was Deployed To a Product Environment</a>
</li>
                                    
<li>
    <a href="../access_openedx_djange_manage/" class="dropdown-item">How To Access An OpenEdX Django Admin manage.py</a>
</li>
                                    
<li>
    <a href="../concourse_github_issues_user_guide/" class="dropdown-item">Concourse github Issues Workflow User Guide</a>
</li>
                                    
<li>
    <a href="../consul_incantations/" class="dropdown-item">Misbehaving consul cluster incident from 20231004-20231905</a>
</li>
                                    
<li>
    <a href="../deploying_concourse/" class="dropdown-item">Deploying Concourse</a>
</li>
                                    
<li>
    <a href="../developer_eks_access/" class="dropdown-item">Developer EKS Access</a>
</li>
                                    
<li>
    <a href="../enable_rapid_response_edxapp/" class="dropdown-item">Enable Rapid Responde in edxapp</a>
</li>
                                    
<li>
    <a href="../faking_it_with_consul_and_vault/" class="dropdown-item">Faking it with Consul and Vault</a>
</li>
                                    
<li>
    <a href="../getting_started_with_concourse/" class="dropdown-item">Getting Started Building Concourse Pipelines in Python</a>
</li>
                                    
<li>
    <a href="../heroku_config_vars/" class="dropdown-item">Heroku config vars</a>
</li>
                                    
<li>
    <a href="../heroku_dynosaur_management/" class="dropdown-item">Heroku Dynosaur Management</a>
</li>
                                    
<li>
    <a href="../heroku_log_drains/" class="dropdown-item">Heroku log drains</a>
</li>
                                    
<li>
    <a href="../import_existing_resources_with_pulumi/" class="dropdown-item">Importing Resources That Already Exist Into Your Pulumi Stack</a>
</li>
                                    
<li>
    <a href="../mitol_deploy_app_with_kubernetes/" class="dropdown-item">Deploying an Application at MIT Open Learning with Kubernetes</a>
</li>
                                    
<li>
    <a href="../mitol_dev_access_to_vault/" class="dropdown-item">OL Secrets Management</a>
</li>
                                    
<li>
    <a href="../mitol_devops_patterns_cookbook/" class="dropdown-item">MIT OL Devops Patterns Cookbook</a>
</li>
                                    
<li>
    <a href="../mitol_kubernetes_cookbook/" class="dropdown-item">MIT OL Kubernetes Cookbook</a>
</li>
                                    
<li>
    <a href="../mitol_openedx_mysql_access/" class="dropdown-item">Querying An MIT OL Open EdX Mysql Database</a>
</li>
                                    
<li>
    <a href="../mitol_openedx_retirement_pipeline/" class="dropdown-item">Setting Up The Retirement Pipeline For A New MIT OL OpenEdX Application</a>
</li>
                                    
<li>
    <a href="../moira_certificates/" class="dropdown-item">Moira Certificates</a>
</li>
                                    
<li>
    <a href="../openedx_release_upgrades/" class="dropdown-item">How To Update The Release Version Of An Open edX Deployment</a>
</li>
                                    
<li>
    <a href="../publish_to_npm/" class="dropdown-item">How to Publish an MIT OL Package to NPM</a>
</li>
                                    
<li>
    <a href="../pulumi_aws_classic_5_to_6_upgrade/" class="dropdown-item">Pulumi AWS Classic 4 To 5 Upgrade</a>
</li>
                                    
<li>
    <a href="../recaptcha/" class="dropdown-item">reCAPTCHA Errors</a>
</li>
                                    
<li>
    <a href="../restore_vault_backups/" class="dropdown-item">So you broke vault?</a>
</li>
                                    
<li>
    <a href="../retire_an_openedx_user/" class="dropdown-item">How To Retire An MIT Online Learning OpenEdX User</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Tagging AMIs with Installed Software Metadata</a>
</li>
                                    
<li>
    <a href="../test_and_deploy_pulumi_packer_projects/" class="dropdown-item">How To Test And Deploy MIT OL Pulumi/Packer Projects</a>
</li>
                                    
<li>
    <a href="../transition_heroku_postgres_db_to_rds/" class="dropdown-item">Moving a Heroku Managed Postgres DB to Pulumi Managed AWS RDS</a>
</li>
                                    
<li>
    <a href="../update_this_site/" class="dropdown-item">Update this site</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Monitoring</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../monitoring/inventory/" class="dropdown-item">Tools</a>
</li>
                                    
<li>
    <a href="../../monitoring/key_labels/" class="dropdown-item">Key Labels used by ODL</a>
</li>
                                    
<li>
    <a href="../../monitoring/overview/" class="dropdown-item">Monitoring Overview</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Post mortems</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../post-mortems/20231030_xpro_outage/" class="dropdown-item">xPro Outage - October 30, 2023</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Runbooks</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../runbooks/oncall/" class="dropdown-item">Oncall</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../retire_an_openedx_user/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../test_and_deploy_pulumi_packer_projects/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                              <button id="theme-menu" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme" class="nav-link dropdown-toggle">
                                <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                <span class="d-lg-none ms-2">Toggle theme</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="true">
                                    <i class="fa-solid fa-sun fa-fw"></i>
                                    <span class="ms-2">Light</span>
                                    <i class="fa-solid fa-check ms-auto"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                                    <i class="fa-solid fa-moon fa-fw"></i>
                                    <span class="ms-2">Dark</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto" aria-pressed="false">
                                    <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                    <span class="ms-2">Auto</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                              </ul>
                            </li>
                    </ul>
                </div>
            </div>
        </div>
        <script src="../../js/darkmode.js"></script>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#tagging-amis-with-installed-software-metadata" class="nav-link">Tagging AMIs with Installed Software Metadata</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#background" class="nav-link">Background</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#implementation" class="nav-link">Implementation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="tagging-amis-with-installed-software-metadata">Tagging AMIs with Installed Software Metadata</h1>
<h2 id="background">Background</h2>
<p>We are looking to start a new pattern where each AMI we produce is tagged with metadata about the software installed on it. This included 3rd party software such as Hashicorp products as well as information our applications. Recently we've been asked 'What version of X is running in production right now?" and it was a surprisingly difficult question to answer. The idea behind this new pattern is to change that, by providing the required information simply by inspecting the AMI behind any running EC2 instance.</p>
<h1 id="implementation">Implementation</h1>
<p>We use <a href="https://pyinfra.com/">pyinfra</a> to do most of the operations involved with creating a new AMI and this is no exception.</p>
<p>Firstly, during the new build we will create a file on the build instance at <code>/etc/ami_tags.json</code> which contains our tag keys and values.</p>
<pre><code>from bilder.lib.ami_helpers import build_tags_document
tags_json = json.dumps(
    build_tags_document(
        source_tags={
            &quot;consul_version&quot;: VERSIONS[&quot;consul&quot;],
            &quot;consul_template_version&quot;: VERSIONS[&quot;consul-template&quot;],
            &quot;vault_version&quot;: VERSIONS[&quot;vault&quot;],
            &quot;docker_repo&quot;: DOCKER_REPO_NAME,
            &quot;docker_digest&quot;: DOCKER_IMAGE_DIGEST,
            &quot;edxapp_repo&quot;: edx_platform.git_origin,
            &quot;edxapp_branch&quot;: edx_platform.release_branch,
            &quot;edxapp_sha&quot;: edx_platform_sha,
            &quot;theme_repo&quot;: theme.git_origin,
            &quot;theme_branch&quot;: theme.release_branch,
            &quot;theme_sha&quot;: theme_sha,
        }
    )
)
files.put(
    name=&quot;Place the tags document at /etc/ami_tags.json&quot;,
    src=io.StringIO(tags_json),
    dest=&quot;/etc/ami_tags.json&quot;,
    mode=&quot;0644&quot;,
    user=&quot;root&quot;,
)
</code></pre>
<p>This file persists as part of the AMI and will exist on any instances spawned from the image.</p>
<p>Next, we need to add three steps to our packer <code>build</code> stanza.</p>
<p>First, we need to retrieve the file we just created remotely in the pyinfra code. We use the same SSH information that we utilized when we ran <code>pyinfra</code>. This needs to be a <code>provisioner</code> step because the build instance still needs to be running in order to copy a file from it.</p>
<pre><code>provisioner &quot;shell-local&quot; {
  inline = [&quot;scp -o StrictHostKeyChecking=no -i /tmp/packer-${build.ID}.pem ${build.User}@${build.Host}:/etc/ami_tags.json /tmp/ami_tags-${build.ID}.json&quot;]
}
</code></pre>
<p>Second, we create a <code>post-processor</code> that generates a <code>packer manifest</code> for the build. This is just a json file local to the machine running the packer build (not the remote ec2 build instance as before). Because this is the first <code>post-processor</code> and follows the last <code>provisioner</code> step, the remote EC2 instance has been terminated and an AMI has been generated. The manifest will contain the AMI ID which is needed for the next step.</p>
<pre><code>post-processor &quot;manifest&quot; {
  output = &quot;/tmp/packer-build-manifest-${build.ID}.json&quot;
}
</code></pre>
<p>Finally, we will take the AMI ID out of the <code>packer manifest</code> and combined with the <code>ami_tags.json</code> file we will make a <code>create-tags</code> call on the newly created AMI to add our metadata to it.</p>
<pre><code>post-processor &quot;shell-local&quot; {
  inline = [&quot;AMI_ID=$(jq -r '.builds[-1].artifact_id' /tmp/packer-build-manifest-${build.ID}.json | cut -d \&quot;:\&quot; -f2)&quot;,
            &quot;export AWS_DEFAULT_REGION=us-east-1&quot;,
            &quot;aws ec2 create-tags --resource $AMI_ID --cli-input-json \&quot;$(cat /tmp/ami_tags-${build.ID}.json)\&quot;&quot;,
            &quot;aws --no-cli-pager ec2 describe-images --image-ids $AMI_ID&quot;]
}
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
