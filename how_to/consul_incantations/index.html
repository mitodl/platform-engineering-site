<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Misbehaving consul cluster incident from 20231004-20231905 - Platform Engineering Documentation Site</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Platform Engineering Documentation Site</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Discoveries</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../discoveries/fargate_service_discovery/" class="dropdown-item">Integrating Fargate Services Into Our Existing Systems Architecture</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">How to</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../access_openedx_djange_manage/" class="dropdown-item">How To Access An OpenEdX Django Admin manage.py</a>
</li>
                                    
<li>
    <a href="../concourse_github_issues_user_guide/" class="dropdown-item">The Problem</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Misbehaving consul cluster incident from 20231004-20231905</a>
</li>
                                    
<li>
    <a href="../deploying_concourse/" class="dropdown-item">Summary</a>
</li>
                                    
<li>
    <a href="../enable_rapid_response_edxapp/" class="dropdown-item">Reference</a>
</li>
                                    
<li>
    <a href="../faking_it_with_consul_and_vault/" class="dropdown-item">Faking it with Consul and Vault</a>
</li>
                                    
<li>
    <a href="../getting_started_with_concourse/" class="dropdown-item">Getting Started Building Concourse Pipelines in Python</a>
</li>
                                    
<li>
    <a href="../heroku_config_vars/" class="dropdown-item">Heroku config vars</a>
</li>
                                    
<li>
    <a href="../heroku_dynosaur_management/" class="dropdown-item">Heroku Dynosaur Management</a>
</li>
                                    
<li>
    <a href="../import_existing_resources_with_pulumi/" class="dropdown-item">Importing Resources That Already Exist Into Your Pulumi Stack</a>
</li>
                                    
<li>
    <a href="../mitol_devops_patterns_cookbook/" class="dropdown-item">Summary</a>
</li>
                                    
<li>
    <a href="../mitol_openedx_retirement_pipeline/" class="dropdown-item">Setting Up The Retirement Pipeline For A New MIT OL OpenEdX Application</a>
</li>
                                    
<li>
    <a href="../moira_certificates/" class="dropdown-item">Moira Certificates</a>
</li>
                                    
<li>
    <a href="../publish_to_npm/" class="dropdown-item">How to Publish an MIT OL Package to NPM</a>
</li>
                                    
<li>
    <a href="../pulumi_aws_classic_5_to_6_upgrade/" class="dropdown-item">Pulumi aws classic 5 to 6 upgrade</a>
</li>
                                    
<li>
    <a href="../recaptcha/" class="dropdown-item">reCAPTCHA Errors</a>
</li>
                                    
<li>
    <a href="../restore_vault_backups/" class="dropdown-item">So you broke vault?</a>
</li>
                                    
<li>
    <a href="../retire_an_openedx_user/" class="dropdown-item">How To Retire An MIT Online Learning OpenEdX User</a>
</li>
                                    
<li>
    <a href="../tagging_amis_with_installed_software_metadata/" class="dropdown-item">Tagging AMIs with Installed Software Metadata</a>
</li>
                                    
<li>
    <a href="../test_and_deploy_pulumi_packer_projects/" class="dropdown-item">How To Test And Deploy MIT OL Pulumi/Packer Projects</a>
</li>
                                    
<li>
    <a href="../transition_heroku_postgres_db_to_rds/" class="dropdown-item">Moving a Heroku Managed Postgres DB to Pulumi Managed AWS RDS</a>
</li>
                                    
<li>
    <a href="../update_this_site/" class="dropdown-item">Update this site</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Openedx</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../openedx/release_upgrades/" class="dropdown-item">How To Update The Release Version Of An Open edX Deployment</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Monitoring</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../monitoring/inventory/" class="dropdown-item">Tools</a>
</li>
                                    
<li>
    <a href="../../monitoring/key_labels/" class="dropdown-item">Key Labels used by ODL</a>
</li>
                                    
<li>
    <a href="../../monitoring/overview/" class="dropdown-item">Monitoring Overview</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Post mortems</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../post-mortems/20231030_xpro_outage/" class="dropdown-item">xPro Outage - October 30, 2023</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Runbooks</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../runbooks/oncall/" class="dropdown-item">Oncall</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../concourse_github_issues_user_guide/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../deploying_concourse/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                              <button id="theme-menu" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme" class="nav-link dropdown-toggle">
                                <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                <span class="d-lg-none ms-2">Toggle theme</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="true">
                                    <i class="fa-solid fa-sun fa-fw"></i>
                                    <span class="ms-2">Light</span>
                                    <i class="fa-solid fa-check ms-auto"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                                    <i class="fa-solid fa-moon fa-fw"></i>
                                    <span class="ms-2">Dark</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto" aria-pressed="false">
                                    <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                    <span class="ms-2">Auto</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                              </ul>
                            </li>
                    </ul>
                </div>
            </div>
        </div>
        <script src="../../js/darkmode.js"></script>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#misbehaving-consul-cluster-incident-from-20231004-20231905" class="nav-link">Misbehaving consul cluster incident from 20231004-20231905</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#overview" class="nav-link">Overview</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#initial-response" class="nav-link">Initial Response</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#research" class="nav-link">Research</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#resolution" class="nav-link">Resolution</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="misbehaving-consul-cluster-incident-from-20231004-20231905">Misbehaving consul cluster incident from 20231004-20231905</h1>
<h1 id="overview">Overview</h1>
<p>At some point <code>operations-production</code> consul cluster fell over and stopped being useful. The root cause was not immediately know but was almost definitely related to an upgrade to <code>1.16.2</code> from <code>???</code> (no good record indication what the cluster was on before all this went down...)</p>
<p>Key takeaway from the logs was this cryptic message about being unable to restore snapshot:</p>
<pre><code>{&quot;@level&quot;:&quot;error&quot;,&quot;@message&quot;:&quot;failed to restore snapshot&quot;,&quot;@module&quot;:&quot;agent.server.raft&quot;,&quot;@timestamp&quot;:&quot;2023-10-04T14:17:40.200037Z&quot;,&quot;error&quot;:&quot;failed to restore snapshot 1156-86945697-1696429059987: failed inserting acl token: missing value for index 'accessor'&quot;}
</code></pre>
<p>This is something that happens anytime a consul server restarts, it gets a copy of the raft from the other servers currently running and restores it. But, it is failing to do that and crashing.</p>
<h1 id="initial-response">Initial Response</h1>
<p>Tobias was able to revive the cluster by downgrading it to 1.14.10 and it was then able to restore the snapshot it received from other nodes / on the filesystem (unclear how broken the cluster was at this time).</p>
<h1 id="research">Research</h1>
<p>Looking up that message returned <a href="https://discuss.hashicorp.com/t/consul-accessorid-is-empty-in-one-of-remote-clusters/53191">one very-not-promising result</a> from the hashicorp forums.</p>
<h1 id="resolution">Resolution</h1>
<p>Ultimitely spent a lot of time reading and pursuing dead ends but what <em>I believe</em> ulimitely resolved the issue was the following:</p>
<ol>
<li>Step through each consul server in the cluster and ensure:
  a. it is on version 1.14.10
  b. It has this acl stanza in <code>00-default.json</code>: <code>"acl": {"enabled":  true, "default_policy": "allow", "enable_token_persistence": false}</code>
  c. Restart the servers one at a time to ensure the quorum never drops below 3 (or 2 if you're in non-prod).</li>
<li>Now you should be able to issue <code>acl</code> commands using the consul cli.
  a. They won't work though because you don't have a token and in this particular case the cluster says it is not elgible for bootstrapping.
  b. At some point in history this very special cluster had ACLs enabled and then disabled? Possibly?</li>
<li>We need to reset/recover the ACL master token. Follow the procedure <a href="https://github.com/hashicorp/consul/issues/5331#issuecomment-462772868">here</a>.</li>
<li>The output of that command should be "Bootstrap Token (Global Management)" an <code>AccessorID</code> and <code>SecretID</code>. Export the secret ID in your terminal as <code>CONSUL_HTTP_TOKEN</code>.</li>
<li>Then you can do <code>consul acl token list</code> and one of them should be labeled "Master Token".
  a. export the <code>SecretID</code> from the Master Token as <code>CONSUL_HTTP_TOKEN</code> or just save it off somewhere.</li>
<li>Repeat step 1, loop through all the servers and remove the <code>acl</code> stanza, restarting one at a time to ensure quorum.</li>
<li>Once all nodes are running again and ACL is disabled, start upgrading the nodes. one at a time, to 1.16.2.</li>
</ol>
<pre><code>wget https://releases.hashicorp.com/consul/1.16.2/consul_1.16.2_linux_amd64.zip
unzip consul_1.16.2_linux_amd64.zip
mv consul consul_1_16_2
systemctl stop consul
cp consul_1_16_2 /usr/local/bin/consul
cd /var/lib
cp -r consul consul_bak
cd consul
rm -rf serf/ raft/ server_metadata.json checkpoint-signature
systemctl start consul
</code></pre>
<ol>
<li>Verify quorum: <code>consul operator raft list-peers</code></li>
<li>Verify version: <code>consul members</code> and <code>consul version</code></li>
</ol></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
