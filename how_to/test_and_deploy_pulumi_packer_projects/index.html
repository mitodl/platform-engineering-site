<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>How To Test And Deploy MIT OL Pulumi/Packer Projects - Platform Engineering Documentation Site</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Platform Engineering Documentation Site</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Discoveries</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../discoveries/fargate_service_discovery/" class="dropdown-item">Integrating Fargate Services Into Our Existing Systems Architecture</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">How to</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../OpenEdX_Prove_Build_Was_Deployed/" class="dropdown-item">Proving That A Particular OpenEdX Build Was Deployed To a Product Environment</a>
</li>
                                    
<li>
    <a href="../access_openedx_djange_manage/" class="dropdown-item">How To Access An OpenEdX Django Admin manage.py</a>
</li>
                                    
<li>
    <a href="../concourse_github_issues_user_guide/" class="dropdown-item">Concourse github Issues Workflow User Guide</a>
</li>
                                    
<li>
    <a href="../consul_incantations/" class="dropdown-item">Misbehaving consul cluster incident from 20231004-20231905</a>
</li>
                                    
<li>
    <a href="../deploying_concourse/" class="dropdown-item">Deploying Concourse</a>
</li>
                                    
<li>
    <a href="../enable_rapid_response_edxapp/" class="dropdown-item">Enable Rapid Responde in edxapp</a>
</li>
                                    
<li>
    <a href="../faking_it_with_consul_and_vault/" class="dropdown-item">Faking it with Consul and Vault</a>
</li>
                                    
<li>
    <a href="../getting_started_with_concourse/" class="dropdown-item">Getting Started Building Concourse Pipelines in Python</a>
</li>
                                    
<li>
    <a href="../heroku_config_vars/" class="dropdown-item">Heroku config vars</a>
</li>
                                    
<li>
    <a href="../heroku_dynosaur_management/" class="dropdown-item">Heroku Dynosaur Management</a>
</li>
                                    
<li>
    <a href="../heroku_log_drains/" class="dropdown-item">Heroku log drains</a>
</li>
                                    
<li>
    <a href="../import_existing_resources_with_pulumi/" class="dropdown-item">Importing Resources That Already Exist Into Your Pulumi Stack</a>
</li>
                                    
<li>
    <a href="../mitol_deploy_app_with_kubernetes/" class="dropdown-item">Deploying an Application at MIT Open Learning with Kubernetes</a>
</li>
                                    
<li>
    <a href="../mitol_dev_access_to_vault/" class="dropdown-item">OL Secrets Management</a>
</li>
                                    
<li>
    <a href="../mitol_devops_patterns_cookbook/" class="dropdown-item">MIT OL Devops Patterns Cookbook</a>
</li>
                                    
<li>
    <a href="../mitol_kubernetes_cookbook/" class="dropdown-item">MIT OL Kubernetes Cookbook</a>
</li>
                                    
<li>
    <a href="../mitol_openedx_mysql_access/" class="dropdown-item">Querying An MIT OL Open EdX Mysql Database</a>
</li>
                                    
<li>
    <a href="../mitol_openedx_retirement_pipeline/" class="dropdown-item">Setting Up The Retirement Pipeline For A New MIT OL OpenEdX Application</a>
</li>
                                    
<li>
    <a href="../moira_certificates/" class="dropdown-item">Moira Certificates</a>
</li>
                                    
<li>
    <a href="../openedx_release_upgrades/" class="dropdown-item">How To Update The Release Version Of An Open edX Deployment</a>
</li>
                                    
<li>
    <a href="../publish_to_npm/" class="dropdown-item">How to Publish an MIT OL Package to NPM</a>
</li>
                                    
<li>
    <a href="../pulumi_aws_classic_5_to_6_upgrade/" class="dropdown-item">Pulumi AWS Classic 4 To 5 Upgrade</a>
</li>
                                    
<li>
    <a href="../recaptcha/" class="dropdown-item">reCAPTCHA Errors</a>
</li>
                                    
<li>
    <a href="../restore_vault_backups/" class="dropdown-item">So you broke vault?</a>
</li>
                                    
<li>
    <a href="../retire_an_openedx_user/" class="dropdown-item">How To Retire An MIT Online Learning OpenEdX User</a>
</li>
                                    
<li>
    <a href="../tagging_amis_with_installed_software_metadata/" class="dropdown-item">Tagging AMIs with Installed Software Metadata</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">How To Test And Deploy MIT OL Pulumi/Packer Projects</a>
</li>
                                    
<li>
    <a href="../transition_heroku_postgres_db_to_rds/" class="dropdown-item">Moving a Heroku Managed Postgres DB to Pulumi Managed AWS RDS</a>
</li>
                                    
<li>
    <a href="../update_this_site/" class="dropdown-item">Update this site</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Monitoring</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../monitoring/inventory/" class="dropdown-item">Tools</a>
</li>
                                    
<li>
    <a href="../../monitoring/key_labels/" class="dropdown-item">Key Labels used by ODL</a>
</li>
                                    
<li>
    <a href="../../monitoring/overview/" class="dropdown-item">Monitoring Overview</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Post mortems</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../post-mortems/20231030_xpro_outage/" class="dropdown-item">xPro Outage - October 30, 2023</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Runbooks</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../runbooks/oncall/" class="dropdown-item">Oncall</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../tagging_amis_with_installed_software_metadata/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../transition_heroku_postgres_db_to_rds/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                              <button id="theme-menu" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme" class="nav-link dropdown-toggle">
                                <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                <span class="d-lg-none ms-2">Toggle theme</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="true">
                                    <i class="fa-solid fa-sun fa-fw"></i>
                                    <span class="ms-2">Light</span>
                                    <i class="fa-solid fa-check ms-auto"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                                    <i class="fa-solid fa-moon fa-fw"></i>
                                    <span class="ms-2">Dark</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto" aria-pressed="false">
                                    <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                    <span class="ms-2">Auto</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                              </ul>
                            </li>
                    </ul>
                </div>
            </div>
        </div>
        <script src="../../js/darkmode.js"></script>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#how-to-test-and-deploy-mit-ol-pulumipacker-projects" class="nav-link">How To Test And Deploy MIT OL Pulumi/Packer Projects</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#the-pipeline" class="nav-link">The Pipeline</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#packer-stage" class="nav-link">Packer Stage</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#deploy-stage" class="nav-link">Deploy Stage</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="how-to-test-and-deploy-mit-ol-pulumipacker-projects">How To Test And Deploy MIT OL Pulumi/Packer Projects</h1>
<p>The way we build images here at MIT OL is complicated and involves a number of
components with various moving parts, so it can be difficult to understand where
to start, what to change, and moreover how to safely test your changes without
breaking production. This document will address these issues.</p>
<h1 id="the-pipeline">The Pipeline</h1>
<p>Each MIT OL project that uses this technique has an accompanying
<a href="https://concourse.io">Concourse</a> pipeline that builds the Packer image, then
deploys that image to the appropriate stage's AWS EC2 launch profile where new
instances will be launched by instance refresh to deploy the new code /
configuration into the wild.</p>
<p>One such project is <a href="https://tika.apache.org/">Tika</a>. It's a data transformation
service used in our data platform. <a href="https://cicd.odl.mit.edu/teams/infrastructure/pipelines/packer-pulumi-tika/">Here is its
pipeline</a>.</p>
<h2 id="packer-stage">Packer Stage</h2>
<p>The first couple stages are reasonable self explanatory:</p>
<ul>
<li>Validate the packer template for any syntax errors and the like</li>
<li>Actually run packer build on the template, invoking pyinfra and packer,
producing an AMI.</li>
</ul>
<p>You can find the pyinfra sources in ol-infrastructure
src/bilder/images/<projectr>. Here is the pyinfra folder for
<a href="https://github.com/mitodl/ol-infrastructure/tree/main/src/bilder/images/tika">Tika</a>.</p>
<h3 id="testing">Testing</h3>
<p>If you want to test the pyinfra portion locally, you can use the following
invocation:</p>
<pre><code># cpatti @ rocinante in ~/src/mit/ol-infrastructure/src/bilder/images/tika on git:main o [17:11:31] C:1
$ pr pyinfra @docker/debian:latest deploy.py
</code></pre>
<p>You should see output similar to the following:</p>
<p><em>TODO: Is there a base image we can use that won't whine about curl/wget and say
no hosts remaining?</em></p>
<pre><code>--&gt; Loading config...

--&gt; Loading inventory...

--&gt; Connecting to hosts...
    [@docker/debian:latest] Connected

--&gt; Preparing Operations...
    Loading: deploy.py
    [@docker/debian:latest] Ready: deploy.py

--&gt; Proposed changes:
    Groups: @docker
    [@docker/debian:latest]   Operations: 32   Change: 32   No change: 0


--&gt; Beginning operation run...
--&gt; Starting operation: Install Hashicorp Products | Ensure unzip is installed
    [@docker/debian:latest] Success

--&gt; Starting operation: Install Hashicorp Products | Create system user for vault
    [@docker/debian:latest] Success

--&gt; Starting operation: Install Hashicorp Products | Download vault archive
    [@docker/debian:latest] sh: 1: curl: not found
    [@docker/debian:latest] sh: 1: wget: not found
    [@docker/debian:latest] Error: executed 0/3 commands
    [@docker/debian:latest] docker build complete, image ID: cc0b00b971bd
--&gt; pyinfra error: No hosts remaining!

</code></pre>
<p>When you're satisfied that your pyinfra build will at least build correctly, you
can trigger a local packer image build that the CI deployment stage can consume
to get your changes into CI. Note that this can take a while, so be prepared for
it to chug for 15-20 minutes. Great time to go get a beverage :)</p>
<p>You can kick this off with an invocation like the following:</p>
<pre><code>poetry run packer build  src/bilder/images/tika/tika.pkr.hcl
</code></pre>
<p>Note that obviously your path will change if the project you're building is
different.</p>
<p>Note also that you may require a slightly different invocation for different
projects. In Tika's case we require a custom Packer template as specified above,
but in the case of other projects which use the default Packer template, you
might use an invocation like the one we use to build Concourse's image:</p>
<pre><code>poetry run packer build -on-error=ask -var node_type=web -var app_name=concourse -only amazon-ebs.third-party src/bilder/images
</code></pre>
<p>Note the node_type and app_name variable declarations above. For Concourse, we
can build either a web image or a worker image, so it's important we include
node_type in our invocation.</p>
<h2 id="deploy-stage">Deploy Stage</h2>
<p>The remaining boxes in the pipeline are deployment stages. One per environment
stage e.g. CI, QA and Production.</p>
<p>Each of these deployment stages basically runs the equivalent of a <code>pulumi up</code>
on the Pulumi stack associated with the application in question. Here's the one
for
<a href="https://github.com/mitodl/ol-infrastructure/tree/main/src/ol_infrastructure/applications/tika">Tika</a>.</p>
<p>Let's take a look at the output from a build of this stage:</p>
<pre><code>INFO:root:@ updating....

8&lt; snip for brevity 8&lt;

INFO:root:    aws:ec2:LaunchTemplate tika-server-tika-ci-launch-template  [diff: ~blockDeviceMappings]

INFO:root:    aws:autoscaling:Group tika-server-tika-ci-auto-scale-group  [diff: ~instanceRefresh,tags,vpcZoneIdentifiers]

INFO:root:@ updating....

INFO:root:    pulumi:pulumi:Stack ol-infrastructure-tika-server-applications.tika.CI

INFO:root:    ol:infrastructure:aws:auto_scale_group:OLAutoScaleGroup tika-server-tika-ci

INFO:root:

INFO:root:Resources:

INFO:root:    17 unchanged
</code></pre>
<p>From this rather verbose blurb we can see that Pulumi updated the ASG and all
associated resources like the Launch template. This is the mechanism which seeds
the updated image into our EC2 environment where instance refresh safely cycles
the old instances out and the ones with our updated code in.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
