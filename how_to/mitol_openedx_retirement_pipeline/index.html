<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Setting Up The Retirement Pipeline For A New MIT OL OpenEdX Application - Platform Engineering Documentation Site</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Platform Engineering Documentation Site</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Discoveries</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../discoveries/fargate_service_discovery/" class="dropdown-item">Integrating Fargate Services Into Our Existing Systems Architecture</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">How to</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../OpenEdX_Prove_Build_Was_Deployed/" class="dropdown-item">Proving That A Particular OpenEdX Build Was Deployed To a Product Environment</a>
</li>
                                    
<li>
    <a href="../access_openedx_djange_manage/" class="dropdown-item">How To Access An OpenEdX Django Admin manage.py</a>
</li>
                                    
<li>
    <a href="../concourse_github_issues_user_guide/" class="dropdown-item">Concourse github Issues Workflow User Guide</a>
</li>
                                    
<li>
    <a href="../consul_incantations/" class="dropdown-item">Misbehaving consul cluster incident from 20231004-20231905</a>
</li>
                                    
<li>
    <a href="../deploying_concourse/" class="dropdown-item">Deploying Concourse</a>
</li>
                                    
<li>
    <a href="../developer_eks_access/" class="dropdown-item">Developer EKS Access</a>
</li>
                                    
<li>
    <a href="../enable_rapid_response_edxapp/" class="dropdown-item">Enable Rapid Responde in edxapp</a>
</li>
                                    
<li>
    <a href="../faking_it_with_consul_and_vault/" class="dropdown-item">Faking it with Consul and Vault</a>
</li>
                                    
<li>
    <a href="../getting_started_with_concourse/" class="dropdown-item">Getting Started Building Concourse Pipelines in Python</a>
</li>
                                    
<li>
    <a href="../heroku_config_vars/" class="dropdown-item">Heroku config vars</a>
</li>
                                    
<li>
    <a href="../heroku_dynosaur_management/" class="dropdown-item">Heroku Dynosaur Management</a>
</li>
                                    
<li>
    <a href="../heroku_log_drains/" class="dropdown-item">Heroku log drains</a>
</li>
                                    
<li>
    <a href="../import_existing_resources_with_pulumi/" class="dropdown-item">Importing Resources That Already Exist Into Your Pulumi Stack</a>
</li>
                                    
<li>
    <a href="../mitol_deploy_app_with_kubernetes/" class="dropdown-item">Deploying an Application at MIT Open Learning with Kubernetes</a>
</li>
                                    
<li>
    <a href="../mitol_dev_access_to_vault/" class="dropdown-item">OL Secrets Management</a>
</li>
                                    
<li>
    <a href="../mitol_devops_patterns_cookbook/" class="dropdown-item">MIT OL Devops Patterns Cookbook</a>
</li>
                                    
<li>
    <a href="../mitol_kubernetes_cookbook/" class="dropdown-item">MIT OL Kubernetes Cookbook</a>
</li>
                                    
<li>
    <a href="../mitol_openedx_mysql_access/" class="dropdown-item">Querying An MIT OL Open EdX Mysql Database</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Setting Up The Retirement Pipeline For A New MIT OL OpenEdX Application</a>
</li>
                                    
<li>
    <a href="../moira_certificates/" class="dropdown-item">Moira Certificates</a>
</li>
                                    
<li>
    <a href="../openedx_release_upgrades/" class="dropdown-item">How To Update The Release Version Of An Open edX Deployment</a>
</li>
                                    
<li>
    <a href="../publish_to_npm/" class="dropdown-item">How to Publish an MIT OL Package to NPM</a>
</li>
                                    
<li>
    <a href="../pulumi_aws_classic_5_to_6_upgrade/" class="dropdown-item">Pulumi AWS Classic 4 To 5 Upgrade</a>
</li>
                                    
<li>
    <a href="../recaptcha/" class="dropdown-item">reCAPTCHA Errors</a>
</li>
                                    
<li>
    <a href="../restore_vault_backups/" class="dropdown-item">So you broke vault?</a>
</li>
                                    
<li>
    <a href="../retire_an_openedx_user/" class="dropdown-item">How To Retire An MIT Online Learning OpenEdX User</a>
</li>
                                    
<li>
    <a href="../tagging_amis_with_installed_software_metadata/" class="dropdown-item">Tagging AMIs with Installed Software Metadata</a>
</li>
                                    
<li>
    <a href="../test_and_deploy_pulumi_packer_projects/" class="dropdown-item">How To Test And Deploy MIT OL Pulumi/Packer Projects</a>
</li>
                                    
<li>
    <a href="../transition_heroku_postgres_db_to_rds/" class="dropdown-item">Moving a Heroku Managed Postgres DB to Pulumi Managed AWS RDS</a>
</li>
                                    
<li>
    <a href="../update_this_site/" class="dropdown-item">Update this site</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Monitoring</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../monitoring/inventory/" class="dropdown-item">Tools</a>
</li>
                                    
<li>
    <a href="../../monitoring/key_labels/" class="dropdown-item">Key Labels used by ODL</a>
</li>
                                    
<li>
    <a href="../../monitoring/overview/" class="dropdown-item">Monitoring Overview</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Post mortems</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../post-mortems/20231030_xpro_outage/" class="dropdown-item">xPro Outage - October 30, 2023</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Runbooks</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../runbooks/oncall/" class="dropdown-item">Oncall</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../mitol_openedx_mysql_access/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../moira_certificates/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                              <button id="theme-menu" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme" class="nav-link dropdown-toggle">
                                <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                <span class="d-lg-none ms-2">Toggle theme</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="true">
                                    <i class="fa-solid fa-sun fa-fw"></i>
                                    <span class="ms-2">Light</span>
                                    <i class="fa-solid fa-check ms-auto"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                                    <i class="fa-solid fa-moon fa-fw"></i>
                                    <span class="ms-2">Dark</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto" aria-pressed="false">
                                    <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                    <span class="ms-2">Auto</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                              </ul>
                            </li>
                    </ul>
                </div>
            </div>
        </div>
        <script src="../../js/darkmode.js"></script>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#setting-up-the-retirement-pipeline-for-a-new-mit-ol-openedx-application" class="nav-link">Setting Up The Retirement Pipeline For A New MIT OL OpenEdX Application</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#getting-set-up" class="nav-link">Getting Set Up</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#retirement-states-creation" class="nav-link">Retirement States Creation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#retirement-user-creation" class="nav-link">Retirement User Creation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#retirement-dot-application-creation" class="nav-link">Retirement DOT Application Creation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#we-keep-secrets-in-the-vault-duh" class="nav-link">We Keep Secrets In The Vault, Duh :)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#start-the-rube-goldberg-device-building-the-pipeline-itself" class="nav-link">START THE RUBE GOLDBERG DEVICE! Building The Pipeline Itself</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="setting-up-the-retirement-pipeline-for-a-new-mit-ol-openedx-application">Setting Up The Retirement Pipeline For A New MIT OL OpenEdX Application</h1>
<h2 id="getting-set-up">Getting Set Up</h2>
<p>First, follow the instructions in the <a href="https://github.com/openedx/edx-documentation/blob/master/en_us/install_operations/source/configuration/user_retire/service_setup.rst">Setting Up User Retirement In The LMS</a> document.</p>
<p>You'll need to ssh into an edx-worker for the appropriate environment you're working in.</p>
<p>Run <code>sudo su - edxapp -s /bin/bash</code> and then <code>source edxapp_env</code> to get to where you need to be to run the Django manage application.</p>
<p>You can follow the doc verbatim with the exception that:
* The manage.py executable is located in the edx-platform folder, so you'd start your invocations with <code>python edx-platform/manage.py</code>
* Ignore the <code>--settings &lt;your settings&gt;</code> option as we already have our settings defined in the LMS configuration.</p>
<p>Be sure that the retirement tates, user and application creation invocations exit without throwing any fatal errors. ALL these scripts unfortunately
print a number of warnings, which can be ignored.</p>
<p>Here's what the output of each section should look approxiately like:</p>
<h2 id="retirement-states-creation">Retirement States Creation</h2>
<pre><code>States have been synchronized. Differences:
   Added: {'COMPLETE', 'FORUMS_COMPLETE', 'ENROLLMENTS_COMPLETE', 'RETIRING_LMS_MISC', 'RETIRING_LMS', 'NOTES_COMPLETE', 'RETIRING_ENROLLMENTS', 'PENDING', 'RETIRING_NOTES', 'PROCTORING_COMPLETE', 'RETIRING_FORUMS', 'ABORTED', 'ERRORED', 'LMS_MISC_COMPLETE', 'RETIRING_PROCTORING', 'LMS_COMPLETE'}
   Removed: set()
   Remaining: set()
States updated successfully. Current states:
PENDING (step 1)
RETIRING_FORUMS (step 11)
FORUMS_COMPLETE (step 21)
RETIRING_ENROLLMENTS (step 31)
ENROLLMENTS_COMPLETE (step 41)
RETIRING_NOTES (step 51)
NOTES_COMPLETE (step 61)
RETIRING_PROCTORING (step 71)
PROCTORING_COMPLETE (step 81)
RETIRING_LMS_MISC (step 91)
LMS_MISC_COMPLETE (step 101)
RETIRING_LMS (step 111)
LMS_COMPLETE (step 121)
ERRORED (step 131)
ABORTED (step 141)
COMPLETE (step 151)
edxapp@ip-10-22-2-49:~$
</code></pre>
<h2 id="retirement-user-creation">Retirement User Creation</h2>
<pre><code>Created new user: &quot;retirement_service_worker&quot;
Setting is_staff for user &quot;retirement_service_worker&quot; to &quot;True&quot;
Setting is_superuser for user &quot;retirement_service_worker&quot; to &quot;True&quot;
Adding user &quot;retirement_service_worker&quot; to groups []
Removing user &quot;retirement_service_worker&quot; from groups []
2023-04-28 21:10:00,691 INFO 69935 [common.djangoapps.student.models.user] [user None] [ip None] user.py:782 - Created new profile for user: retirement_service_worker
</code></pre>
<h2 id="retirement-dot-application-creation">Retirement DOT Application Creation</h2>
<pre><code>None] [ip None] create_dot_application.py:82 - Created retirement application with id: 10, client_id: XXXXXXXXXXXXXXXXXXXXXXXX, and client_secret: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
</code></pre>
<p>You'll need to save this client_id and secret somewhere because you'll need to use it in the next step!</p>
<h2 id="we-keep-secrets-in-the-vault-duh">We Keep Secrets In The Vault, Duh :)</h2>
<p>Next, we'll need to make these secrets accessible to the pipeline so they can be consumed by the various retirement worker scripts.</p>
<p>In order to do that, we'll use a utility called <a href="https://github.com/mozilla/sops">sops</a> to encrypt the secrets so we can safely store them in Github and conveyed to Vault.</p>
<p>Unfortunately setting yourself up to use sops is a bit of a process in and of itself and it outside the scope of this document.</p>
<p>Once you've got sops squared away, use it on the appropriate operational configuration file. Here's the one for <a href="https://github.com/mitodl/ol-infrastructure/blob/main/src/bridge/secrets/concourse/operations.qa.yaml">QA</a>.</p>
<p>So you'd invoke: <code>sops operations.qa.yml</code>. At that point, sops will decrypt the file and open your editor of choice with its contents.</p>
<p>Now, we want to add the necessary secrets we copied in the previous step, as well as the LMS host for this environment. You can find the
LMS hosts for the various environments listed in the <a href="https://github.mit.edu/odl-engineering/project-status/wiki/App-Links">App Links</a> Wiki page.</p>
<p>If you're unsure, ask an old hand for help. Disambiguating the various environments can be tricky, and better safe than sorry!</p>
<p>Here's an example of what I added for mitxonline qa:</p>
<pre><code>  mitxonline/tubular_oauth_client:
    id: CLIENTIDUNENCRYPTEDSECRETSAREFUNYESTHEYARE
    secret: EVENMORESLIGHTLYLONGERGIBBERISHTHATISYOURUNENCRYPTEDSECRET
    host: https://courses-qa.mitxonline.mit.edu
</code></pre>
<p>Once you've made your additions, save the file and quit your editor. sops will now do its magic and re-encrypt those values.</p>
<p><strong>BE SURE NOT TO COMMIT UNENDCRYPTED SECRETS TO GITHUB</strong>.</p>
<p>Now create a pull request and get these changes merged. If this is for production, you'll also need to kick off <a href="https://cicd.odl.mit.edu/teams/infrastructure/pipelines/packer-pulumi-concourse">this pipeline</a> manually.</p>
<p>At this point, your secrets should be in vault and available to the pipeline we're about to build.</p>
<h2 id="start-the-rube-goldberg-device-building-the-pipeline-itself">START THE RUBE GOLDBERG DEVICE! Building The Pipeline Itself</h2>
<p>In order to get this done, you'll need to have the <a href="https://concourse-ci.org/">Concourse</a> <code>fly</code> CLI command installed and an appropriate target for your
Concourse server and team defined.</p>
<p>I like to keep my target names reasonably short, so for the target I created for mitxonline QA, I ran:</p>
<p><code>fly login --target mo-qa --team-name=mitxonline --concourse-url https://cicd-qa.odl.mit.edu</code></p>
<p>Once we have a suitable target defined, we can use it to actually create our pipeline for real:</p>
<ul>
<li>From a checked out mitodl/ol-infrastructure repository, change directory to the <code>src/ol_concourse/pipelines/open_edx/tubular</code> folder.</li>
<li>Run <code>poetry run python tubular.py</code> - This should print a reasonable looking blob of JSON to the screen with a fly command to run at the bottom.</li>
<li>Go ahead and run that command! For example, given the mo-qa target I defined above, I ran: <code>fly -t mo-qa sp -p misc-cloud-tubular -c definition.json</code>.</li>
<li>At this point fly should show you the pipeline definition and will ask you if you want to actually make the change. Answer yes.</li>
<li>Assuming there were no errors, your pipeline definition should be in place and we're ready to get the ball rolling!</li>
<li>You can either use the fly unpause-pipeline or else, in the Concourse web UI, click the little Play icon at the very top right of the screen. <!-- TODO add screenshot --></li>
<li>The build is set to run once a week, so once you unpause the pipeline, you may noeed to click the + icon in order to actually kick off a build.</li>
</ul>
<p>That's it! Obviously keep an eye out on the pipeline for any failures.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
