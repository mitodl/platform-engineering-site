<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Restoring Vault Backups - Platform Engineering Documentation</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">Platform Engineering Documentation</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Getting Started</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../getting_started/emergency-break-glass/" class="dropdown-item">Emergency Oncall Break Glass Procedure</a>
</li>
                                    
<li>
    <a href="../../../getting_started/developer_eks_access/" class="dropdown-item">Developer EKS Access</a>
</li>
                                    
<li>
    <a href="../../../getting_started/vault_access_for_developers/" class="dropdown-item">Vault Access for Developers</a>
</li>
                                    
<li>
    <a href="../../../getting_started/update_this_site/" class="dropdown-item">Updating This Site</a>
</li>
                                    
<li>
    <a href="../../../getting_started/pe-product-infra-map/" class="dropdown-item">Applications & Services</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Platform Services</a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Secrets Management (Vault)</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Restoring Vault Backups</a>
</li>
            
<li>
    <a href="../faking_it_with_consul_and_vault/" class="dropdown-item">Faking It with Consul and Vault</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Service Discovery (Consul)</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../service_discovery/consul_incantations/" class="dropdown-item">Consul Incantations</a>
</li>
            
<li>
    <a href="../../service_discovery/fargate_service_discovery/" class="dropdown-item">Fargate Service Discovery</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Container Orchestration (Kubernetes)</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../container_orchestration/deploying_apps_with_kubernetes/" class="dropdown-item">Deploying Apps with Kubernetes</a>
</li>
            
<li>
    <a href="../../container_orchestration/kubernetes_cookbook/" class="dropdown-item">Kubernetes Cookbook</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">CI/CD (Concourse)</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../ci_cd/getting_started_with_concourse/" class="dropdown-item">Getting Started with Concourse</a>
</li>
            
<li>
    <a href="../../ci_cd/deploying_concourse/" class="dropdown-item">Deploying Concourse</a>
</li>
            
<li>
    <a href="../../ci_cd/concourse_github_issues_user_guide/" class="dropdown-item">Concourse GitHub Issues User Guide</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Cloud Infrastructure (AWS & Pulumi)</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../cloud_infrastructure/pulumi_aws_classic_5_to_6_upgrade/" class="dropdown-item">Pulumi AWS Classic 5 to 6 Upgrade</a>
</li>
            
<li>
    <a href="../../cloud_infrastructure/import_existing_resources_with_pulumi/" class="dropdown-item">Importing Existing Resources with Pulumi</a>
</li>
            
<li>
    <a href="../../cloud_infrastructure/test_and_deploy_pulumi_packer_projects/" class="dropdown-item">Testing and Deploying Pulumi Packer Projects</a>
</li>
            
<li>
    <a href="../../cloud_infrastructure/tagging_amis_with_installed_software_metadata/" class="dropdown-item">Tagging AMIs with Software Metadata</a>
</li>
            
<li>
    <a href="../../cloud_infrastructure/moira_certificates/" class="dropdown-item">Moira Certificates</a>
</li>
            
<li>
    <a href="../../cloud_infrastructure/recaptcha/" class="dropdown-item">Recaptcha</a>
</li>
            
<li>
    <a href="../../cloud_infrastructure/publishing_to_npm/" class="dropdown-item">Publishing to NPM</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Application Specific Guides</a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Open edX</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../application_specific_guides/openedx/prove_build_was_deployed/" class="dropdown-item">Proving Build Was Deployed</a>
</li>
            
<li>
    <a href="../../../application_specific_guides/openedx/access_django_manage/" class="dropdown-item">Accessing Django Manage</a>
</li>
            
<li>
    <a href="../../../application_specific_guides/openedx/enable_rapid_response_edxapp/" class="dropdown-item">Enabling Rapid Response edXApp</a>
</li>
            
<li>
    <a href="../../../application_specific_guides/openedx/mysql_access/" class="dropdown-item">MySQL Access</a>
</li>
            
<li>
    <a href="../../../application_specific_guides/openedx/retirement_pipeline/" class="dropdown-item">Retirement Pipeline</a>
</li>
            
<li>
    <a href="../../../application_specific_guides/openedx/release_upgrades/" class="dropdown-item">Release Upgrades</a>
</li>
            
<li>
    <a href="../../../application_specific_guides/openedx/retire_an_openedx_user/" class="dropdown-item">Retiring a User</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Heroku (Legacy)</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../application_specific_guides/heroku_legacy/config_vars/" class="dropdown-item">Config Vars</a>
</li>
            
<li>
    <a href="../../../application_specific_guides/heroku_legacy/dynosaur_management/" class="dropdown-item">Dynosaur Management</a>
</li>
            
<li>
    <a href="../../../application_specific_guides/heroku_legacy/log_drains/" class="dropdown-item">Log Drains</a>
</li>
            
<li>
    <a href="../../../application_specific_guides/heroku_legacy/transition_postgres_db_to_rds/" class="dropdown-item">Transitioning Postgres DB to RDS</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">OCW Studio</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../application_specific_guides/ocw-studio/Update_OCW_Studio_Pipeline/" class="dropdown-item">Updating The OCW Studio Pipeline</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">ODL-bot / Doof</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../application_specific_guides/odlbot/Resetting_Doof_Github_Token.md" class="dropdown-item">Updating odlbot/doof Github Access Token</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Renovate</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../application_specific_guides/renovate/updating_renovate_config/" class="dropdown-item">Updating Renovate Configuration</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">JupyterHub</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../application_specific_guides/jupyterhub/jupyterhub_admin_guide/" class="dropdown-item">JupyterHub Admin Guide</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Monitoring And Observability</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../monitoring_observability/overview/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../../monitoring_observability/inventory/" class="dropdown-item">Inventory</a>
</li>
                                    
<li>
    <a href="../../../monitoring_observability/key_labels/" class="dropdown-item">Key Labels</a>
</li>
                                    
<li>
    <a href="../../../monitoring_observability/bump_sentry_credit/" class="dropdown-item">Bumping Sentry Credit</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Runbooks & Post-Mortems</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../runbooks_post_mortems/oncall_runbook/" class="dropdown-item">On-Call Runbook</a>
</li>
                                    
<li>
    <a href="../../../runbooks_post_mortems/20231030_xpro_outage/" class="dropdown-item">20231030 xPro Outage Post-Mortem</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Cookbooks & Patterns</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../cookbooks_patterns/devops_patterns_cookbook/" class="dropdown-item">DevOps Patterns Cookbook</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Partner Documentation</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../sso_onboarding/sso_config/" class="dropdown-item">Integrating With MIT Learn SSO</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../../getting_started/pe-product-infra-map/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../faking_it_with_consul_and_vault/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                              <button id="theme-menu" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme" class="nav-link dropdown-toggle">
                                <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                <span class="d-lg-none ms-2">Toggle theme</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="true">
                                    <i class="fa-solid fa-sun fa-fw"></i>
                                    <span class="ms-2">Light</span>
                                    <i class="fa-solid fa-check ms-auto"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                                    <i class="fa-solid fa-moon fa-fw"></i>
                                    <span class="ms-2">Dark</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto" aria-pressed="false">
                                    <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                    <span class="ms-2">Auto</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                              </ul>
                            </li>
                    </ul>
                </div>
            </div>
        </div>
        <script src="../../../js/darkmode.js"></script>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#so-you-broke-vault" class="nav-link">So you broke vault?</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#symptoms" class="nav-link">Symptoms</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#what-to-do" class="nav-link">What to do!?!</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="so-you-broke-vault">So you broke vault?</h1>
<h2 id="symptoms">Symptoms</h2>
<ul>
<li>The vault UI or CLI reports that the cluster is sealed and there is no amount of coaxing to get it out of that state.</li>
<li>There may be other symptoms. Add to this list as needed.</li>
</ul>
<pre><code>root@ip-172-16-0-82:/etc/vault/# VAULT_SKIP_VERIFY=true vault status
Key                      Value
---                      -----
Recovery Seal Type       awskms
Initialized              false                 &lt;&lt;&lt;&lt;&lt; Ahh! Bad!
Sealed                   true                  &lt;&lt;&lt;&lt;&lt; Sealed!
Total Recovery Shares    0
Threshold                0
Unseal Progress          0/0                   &lt;&lt;&lt;&lt;&lt; This node knowns nothing about any other nodes
Unseal Nonce             n/a
Version                  1.14.1
Build Date               2023-07-21T10:15:14Z
Storage Type             raft
HA Enabled               true                  &lt;&lt;&lt;&lt;&lt; And it is supposed too!
</code></pre>
<h2 id="what-to-do">What to do!?!</h2>
<ol>
<li>Go to the apporpriate S3 bucket and find the most recent backup. Production backs up every six hours. QA + CI backup once a day. Bucket names are: <strong>ol-infra-ci-vault-backups</strong>, <strong>ol-infra-qa-vault-backups</strong>, <strong>ol-infra-production-vault-backups</strong>.</li>
<li>Download the most recent backup locally to your machine and stage it to the vault node you're going to run the restore on. <strong>You only run this procedure ONCE! You do not need to run this on every vault node.</strong></li>
</ol>
<pre><code>scp -i &lt;path to your oldevops.pem ssh private key&gt; &lt;path to downloaded .snapshot file&gt; admin@&lt;IP address of the vault node you're restoring to&gt;:/tmp
</code></pre>
<ol>
<li>On the node that you've copied the <code>.snapshot</code> file to, verify that the vault status outputs as above.</li>
<li>Export a vault setting to make life less annoying <code>export VAULT_SKIP_VERIFY=true</code></li>
<li>Initialize the vault cluster: <code>vault operator init</code></li>
<li>Output will look like this:</li>
</ol>
<pre><code>Recovery Key 1: bX5A***********************************ExhBC
Recovery Key 2: XHo3***********************************LZxmZ
Recovery Key 3: EEOE***********************************XWC8p
Recovery Key 4: FyTq***********************************EY0ij
Recovery Key 5: oXaW***********************************Wr74k

Initial Root Token: hvs.**********************wf

Success! Vault is initialized

Recovery key initialized with 5 key shares and a key threshold of 3. Please
securely distribute the key shares printed above.
</code></pre>
<ol>
<li>The message says those recovery keys are important but they aren't in this case. You don't need to save them. What you do need is the initial root token. Export that into env var: <code>export VAULT_TOKEN=&lt;token value including hvs. from prev command output&gt;</code></li>
<li>Do the restore: <code>vault operator raft snapshot restore &lt;path to .snapshot file&gt;</code>. It doesn't actually output anything.</li>
<li>Unset VAULT_TOKEN with <code>unset VAULT_TOKEN</code> (because that token was tied the shortlived cluster that existed before running the restore). Then do a vault status: <code>vault status</code> and it should look something like this:</li>
</ol>
<pre><code>Key                      Value
---                      -----
Recovery Seal Type       shamir
Initialized              true
Sealed                   false                                       &lt;&lt;&lt;&lt; Victory!
Total Recovery Shares    2
Threshold                2
Version                  1.14.1
Build Date               2023-07-21T10:15:14Z
Storage Type             raft
Cluster Name             vault-cluster-ab3e7a1b
Cluster ID               ef172e45-fake-uuid-here-aeb8da8a7179
HA Enabled               true
HA Cluster               https://256.256.256.256:8201
HA Mode                  standby
Active Node Address      https://active.vault.service.consul:8200
Raft Committed Index     815551
Raft Applied Index       815551
</code></pre>
<ol>
<li>Loop through the other nodes in the cluster and verify they have a similar vault unseal status. If they don't, try <code>systemctl restart vault</code>. They <em>should</em> join backup and restore the raft on their own provided they were broken to begin with.</li>
<li>Verify that the vault UI works as excpected again and your secrets are there.</li>
<li><strong>Some, possibly serious, complications after doing this:</strong> it is possible that there are credential secrets out in the wild being used that are no longer tracked via leases in vault. For instance if they were issued between when the backup took place and when the cluster stopped being viable. This could be the case for PKI secrets as well and of course if any static secrets in vaults were changed between the backup and beginning of the outage.</li>
</ol></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js"></script>
        <script src="../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
