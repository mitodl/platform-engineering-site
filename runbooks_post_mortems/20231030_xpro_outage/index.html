<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>20231030 xPro Outage Post-Mortem - Platform Engineering Documentation</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Platform Engineering Documentation</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Getting Started</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../getting_started/emergency-break-glass/" class="dropdown-item">Emergency Oncall Break Glass Procedure</a>
</li>
                                    
<li>
    <a href="../../getting_started/developer_eks_access/" class="dropdown-item">Developer EKS Access</a>
</li>
                                    
<li>
    <a href="../../getting_started/vault_access_for_developers/" class="dropdown-item">Vault Access for Developers</a>
</li>
                                    
<li>
    <a href="../../getting_started/update_this_site/" class="dropdown-item">Updating This Site</a>
</li>
                                    
<li>
    <a href="../../getting_started/pe-product-infra-map/" class="dropdown-item">Applications & Services</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Platform Services</a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Secrets Management (Vault)</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../platform_services/secrets_management/restore_vault_backups/" class="dropdown-item">Restoring Vault Backups</a>
</li>
            
<li>
    <a href="../../platform_services/secrets_management/faking_it_with_consul_and_vault/" class="dropdown-item">Faking It with Consul and Vault</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Service Discovery (Consul)</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../platform_services/service_discovery/consul_incantations/" class="dropdown-item">Consul Incantations</a>
</li>
            
<li>
    <a href="../../platform_services/service_discovery/fargate_service_discovery/" class="dropdown-item">Fargate Service Discovery</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Container Orchestration (Kubernetes)</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../platform_services/container_orchestration/deploying_apps_with_kubernetes/" class="dropdown-item">Deploying Apps with Kubernetes</a>
</li>
            
<li>
    <a href="../../platform_services/container_orchestration/kubernetes_cookbook/" class="dropdown-item">Kubernetes Cookbook</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">CI/CD (Concourse)</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../platform_services/ci_cd/getting_started_with_concourse/" class="dropdown-item">Getting Started with Concourse</a>
</li>
            
<li>
    <a href="../../platform_services/ci_cd/deploying_concourse/" class="dropdown-item">Deploying Concourse</a>
</li>
            
<li>
    <a href="../../platform_services/ci_cd/concourse_github_issues_user_guide/" class="dropdown-item">Concourse GitHub Issues User Guide</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Cloud Infrastructure (AWS & Pulumi)</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../platform_services/cloud_infrastructure/pulumi_aws_classic_5_to_6_upgrade/" class="dropdown-item">Pulumi AWS Classic 5 to 6 Upgrade</a>
</li>
            
<li>
    <a href="../../platform_services/cloud_infrastructure/import_existing_resources_with_pulumi/" class="dropdown-item">Importing Existing Resources with Pulumi</a>
</li>
            
<li>
    <a href="../../platform_services/cloud_infrastructure/test_and_deploy_pulumi_packer_projects/" class="dropdown-item">Testing and Deploying Pulumi Packer Projects</a>
</li>
            
<li>
    <a href="../../platform_services/cloud_infrastructure/tagging_amis_with_installed_software_metadata/" class="dropdown-item">Tagging AMIs with Software Metadata</a>
</li>
            
<li>
    <a href="../../platform_services/cloud_infrastructure/moira_certificates/" class="dropdown-item">Moira Certificates</a>
</li>
            
<li>
    <a href="../../platform_services/cloud_infrastructure/recaptcha/" class="dropdown-item">Recaptcha</a>
</li>
            
<li>
    <a href="../../platform_services/cloud_infrastructure/publishing_to_npm/" class="dropdown-item">Publishing to NPM</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Application Specific Guides</a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Open edX</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../application_specific_guides/openedx/prove_build_was_deployed/" class="dropdown-item">Proving Build Was Deployed</a>
</li>
            
<li>
    <a href="../../application_specific_guides/openedx/access_django_manage/" class="dropdown-item">Accessing Django Manage</a>
</li>
            
<li>
    <a href="../../application_specific_guides/openedx/enable_rapid_response_edxapp/" class="dropdown-item">Enabling Rapid Response edXApp</a>
</li>
            
<li>
    <a href="../../application_specific_guides/openedx/mysql_access/" class="dropdown-item">MySQL Access</a>
</li>
            
<li>
    <a href="../../application_specific_guides/openedx/retirement_pipeline/" class="dropdown-item">Retirement Pipeline</a>
</li>
            
<li>
    <a href="../../application_specific_guides/openedx/release_upgrades/" class="dropdown-item">Release Upgrades</a>
</li>
            
<li>
    <a href="../../application_specific_guides/openedx/retire_an_openedx_user/" class="dropdown-item">Retiring a User</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Heroku (Legacy)</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../application_specific_guides/heroku_legacy/config_vars/" class="dropdown-item">Config Vars</a>
</li>
            
<li>
    <a href="../../application_specific_guides/heroku_legacy/dynosaur_management/" class="dropdown-item">Dynosaur Management</a>
</li>
            
<li>
    <a href="../../application_specific_guides/heroku_legacy/log_drains/" class="dropdown-item">Log Drains</a>
</li>
            
<li>
    <a href="../../application_specific_guides/heroku_legacy/transition_postgres_db_to_rds/" class="dropdown-item">Transitioning Postgres DB to RDS</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">OCW Studio</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../application_specific_guides/ocw-studio/Update_OCW_Studio_Pipeline/" class="dropdown-item">Updating The OCW Studio Pipeline</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Monitoring & Observability</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../monitoring_observability/overview/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../monitoring_observability/inventory/" class="dropdown-item">Inventory</a>
</li>
                                    
<li>
    <a href="../../monitoring_observability/key_labels/" class="dropdown-item">Key Labels</a>
</li>
                                    
<li>
    <a href="../../monitoring_observability/bump_sentry_credit/" class="dropdown-item">Bumping Sentry Credit</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Runbooks & Post-Mortems</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../oncall_runbook/" class="dropdown-item">On-Call Runbook</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">20231030 xPro Outage Post-Mortem</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Cookbooks & Patterns</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../cookbooks_patterns/devops_patterns_cookbook/" class="dropdown-item">DevOps Patterns Cookbook</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Partner Documentation</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../sso_onboarding/sso_config/" class="dropdown-item">Integrating With MIT Learn SSO</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../oncall_runbook/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../cookbooks_patterns/devops_patterns_cookbook/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                              <button id="theme-menu" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme" class="nav-link dropdown-toggle">
                                <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                <span class="d-lg-none ms-2">Toggle theme</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="true">
                                    <i class="fa-solid fa-sun fa-fw"></i>
                                    <span class="ms-2">Light</span>
                                    <i class="fa-solid fa-check ms-auto"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                                    <i class="fa-solid fa-moon fa-fw"></i>
                                    <span class="ms-2">Dark</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto" aria-pressed="false">
                                    <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                    <span class="ms-2">Auto</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                              </ul>
                            </li>
                    </ul>
                </div>
            </div>
        </div>
        <script src="../../js/darkmode.js"></script>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#xpro-outage-october-30-2023" class="nav-link">xPro Outage - October 30, 2023</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#timeline" class="nav-link">Timeline</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#root-cause" class="nav-link">Root Cause:</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#action-items" class="nav-link">Action Items</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="xpro-outage-october-30-2023">xPro Outage - October 30, 2023</h1>
<h2 id="timeline">Timeline</h2>
<p>Undetermined date within the past 6 months:</p>
<ul>
<li>AWS RDS config updated to default new credentials to use SCRAM rather than md5</li>
</ul>
<p>Monday, October 30th 2023
- 3:45PM - Configuration update deployed xPro Production Heroku stack via Salt.
- 3:51PM - <a href="https://mitodl.app.opsgenie.com/alert/detail/909993c0-72e7-4433-9e9e-30a2196e8f87-1698695490940/details">Pingdom alerts DevOps on-call</a>.
- 3:51PM - Alert Acknowledged by DevOps on-call (Mike Davidson).
- 3:52PM - Verified that site was non-responsive.
- 3:52PM - Begin detailed investigation.
- ~3:53PM - Confirm log messages in Heroku regarding failed database logins:</p>
<pre><code>LOG C-0x55cb586d2540: db1/v-aws-mitxpro-OC7crfPS2rL3jSryzvHE-1698696728@127.0.0.1:55038 login attempt: db=db1 user=v-aws-mitxpro-OC7crfPS2rL3jSryzvHE-1698696728 tls=no
ERROR S-0x55cb586d5580: db1/v-aws-mitxpro-OC7crfPS2rL3jSryzvHE-1698696728@3.209.36.28:5432 cannot do SCRAM authentication: wrong password type
LOG C-0x55cb586d2e00: db1/v-aws-mitxpro-OC7crfPS2rL3jSryzvHE-1698696728@127.0.0.1:52474 closing because: server login failed: wrong password type (age=14s)
</code></pre>
<ul>
<li>~3:55PM Determined this matches the fingerprint of a previously encountered issue seen when setting up the new MITOpen environments.</li>
<li>3:56PM Found <a href="https://github.com/mitodl/ol-infrastructure/pull/1703">previous PR</a> that addressed this for MITOpen:</li>
<li>3:56PM Started looking for code location for make the above modification.</li>
<li>4:00PM Unable to locate code for this environment. Determined it is not managed by pulumi.</li>
<li>4:03PM Started a zoom call. Attendees: Mike, Tobias, Sar</li>
<li>4:05PM Decided making the database parameter group configuration will possibly take longer than is desirable. Opt for trying the alternative resolution.</li>
<li>~4:07PM Role definition in vault is modified and verified to still generate credentials via the Vault UI.</li>
<li>4:09PM Cached credentials are cleared and Heroku configuration is re-applied via Salt.</li>
<li>~4:10PM Verified the issue is not resolved.</li>
<li>4:12PM Cleared cached credentials again and Heroku configuration is re-applied via Salt.</li>
<li>4:14PM Verified the issue is not resolved and that the credentials applied via Salt are truely different.</li>
<li>4:15PM Decided alternative solution did not work. Begin implementing database parameter group fix known to work.</li>
<li>~4:20PM A new database parameter group is created and applied to the running database.</li>
<li>~4:23PM The database is listed as Available in the RDS web console.</li>
<li>4:24PM Cleared cached credentials again and Heroku configuration is re-applied via Salt.</li>
<li>4:25PM Verified the site is now available again and login/other database interactions work.</li>
<li>4:25PM Pingdom automatically closes the OpsGenie alert.</li>
</ul>
<h2 id="root-cause">Root Cause:</h2>
<p>At some point in the last 6 months, the default behavior of the underlying RDS instance for xPro production was transitioned to using SCRAM password authentication rather than MD5 password authentication. Further information about this is documented <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Appendix.PostgreSQL.CommonDBATasks.Roles.html">here</a>. The <a href="https://github.com/heroku/heroku-buildpack-pgbouncer/issues/155">buildpack</a> we use in Heroku for pgbouncer does not support SCRAM.</p>
<p>When managing configuration items for applications deployed in Heroku, we invoke Vault via SaltStack to generate database credentials. These credentials are then cached on the Salt Master. Vault tracks the credentials it generates via internal objects known as 'leases'. When Salt checked + applied the configuration at 3:45PM, it saw that the lease was due to expire soon and was not eligible for renewal. This triggered Vault generating new credentials, however these new credentials were generated with the new default SCRAM configuration rather than the MD5 configuration supported by pgbouncer.</p>
<p>When attempting to establish a pool of database connections, pgbouncer was rejected by the RDS instance for sending the wrong password type. It sent an MD5 password hash while the database expected SCRAM for the newly generated credential. Being unable to establish a connection to the database is a fatal error for the application and it was not able to finish starting up and serving requests.</p>
<h2 id="action-items">Action Items</h2>
<ul>
<li><a href="https://github.com/mitodl/ol-infrastructure/issues/1886">Migrate management of XPro resources into Pulumi</a></li>
<li>One of the key factors delaying the resolution of the outage was the fact that none, or nearly none, of the configuration for this stack was managed as code. In particular the RDS instance and its associated resources. Additionally, the RDS instance was using an instance of the default parameter group provided by AWS, which cannot be modified. As such, we were required to duplicate this default parameter group definitions, make the required modifications, and then associate the newly created group with the instance. This is a more time consuming task than modifying a parameter configuration on an already associated parameter group. All of this would have been mitigated if the resources were managed with pulumi, where we do not utilize AWS sourced default parameter groups.</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
